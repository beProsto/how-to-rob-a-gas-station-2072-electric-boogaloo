<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
	<title>How To Rob A Gas Station 2072 - Electric Boogaloo</title>

	<style>
		body {
			background: black;
		}
	</style>

	<script>
		// Encapsulates logging (printing) functionality
		class Logger {
			constructor() {
				this.logBuffer = "";
				this.module = {};
			}
			printChar(ch) {
				const char = String.fromCharCode(ch);
				if (char == "\n") {
					console.log(this.logBuffer);
					this.logBuffer = "";
				}
				else {
					this.logBuffer += char;
				}
			}
			printString(str) {
				const mem = new Uint8Array(this.module.instance.exports.memory.buffer);
				for (let i = str; mem[i] != 0; i++) {
					this.printChar(mem[i]);
				}
			}
			printNumber(num) {
				this.logBuffer += String(num);
			}
		}

		// Encapsulate (serialised) input
		class Input {
			constructor() {
				this.integers = [];
				this.booleans = [];

				this.module = {};

				window.onmousemove = (e) => {
					this.integers[0] = e.clientX;
					this.integers[1] = e.clientY;
					this.integers[2] = e.movementX;
					this.integers[3] = e.movementY;
				};
				window.onwheel = (e) => {
					this.integers[4] = e.deltaX;
					this.integers[5] = e.deltaY;
				};
				window.onmousedown = (e) => { this.booleans[256 + e.button] = true; };
				window.onmouseup = (e) => { this.booleans[256 + e.button] = false; };
				window.addEventListener('wheel', (e) => { e.preventDefault(); }, { passive: false });
				window.oncontextmenu = (e) => { e.preventDefault(); };
				//window.onbeforeunload = (e) => { e.preventDefault(); return "Are you sure"; };
				window.onkeydown = (e) => { e.preventDefault(); this.booleans[e.which] = true; };
				window.onkeyup = (e) => { this.booleans[e.which] = false; };
			}
			// Put serialised data in the input structure
			get(ptr) {
				const position_delta_scroll = new Int32Array(this.module.instance.exports.memory.buffer, ptr, 6);
				for (let i = 0; i < 6; i++) {
					position_delta_scroll[i] = this.integers[i];
				}
				const keys_buttons = new Uint8Array(this.module.instance.exports.memory.buffer, ptr + 24, 261);
				for (let i = 0; i < 261; i++) {
					keys_buttons[i] = this.booleans[i];
				}
			}
			// Values that need resetting each frame:
			update() {
				this.integers[2] = 0;
				this.integers[3] = 0;
				this.integers[4] = 0;
				this.integers[5] = 0;
			}
		}


		// Entry point of the application
		window.onload = async () => {
			// const strToTxt = (strptr) => {
			//     const memory_buffer = new Uint8Array(wasmModule.instance.exports.memory.buffer, strptr, wasmModule.instance.exports.strlen(strptr));
			//     let text_buffer = new TextDecoder().decode(memory_buffer);
			//     return text_buffer;
			// };

			const logger = new Logger();
			const input = new Input();

			const wasmModule = await WebAssembly.instantiateStreaming(
				fetch("./build/main.wasm"),
				{
					env: {
						// Printing (logging)
						env_ps: (s) => logger.printString(s),
						env_pn: (n) => logger.printNumber(n),
						env_pc: (c) => logger.printChar(c),
						// Polling input values all at once
						env_ig: (ptr) => input.get(ptr),
					}
				}
			);

			logger.module = wasmModule;
			input.module = wasmModule;

			wasmModule.instance.exports.main();

			const gameLoop = (dt) => {
				wasmModule.instance.exports.loop();

				input.update();
				window.requestAnimationFrame(gameLoop);
			};
			window.requestAnimationFrame(gameLoop);
		};
	</script>
</head>

<body>

</body>

</html>