<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
	<title>How To Rob A Gas Station 2072 - Electric Boogaloo</title>

	<style>
		body {
			background: black;
		}
	</style>

	<script>
		// Encapsulates logging (printing) functionality
		class Logger {
			constructor() {
				this.logBuffer = "";
				this.module = {};
			}
			printChar(ch) {
				const char = String.fromCharCode(ch);
				if (char == "\n") {
					console.log(this.logBuffer);
					this.logBuffer = "";
				}
				else {
					this.logBuffer += char;
				}
			}
			printString(str) {
				const mem = new Uint8Array(this.module.instance.exports.memory.buffer);
				for (let i = str; mem[i] != 0; i++) {
					this.printChar(mem[i]);
				}
			}
			printNumber(num) {
				this.logBuffer += String(num);
			}
		}

		// Encapsulate input
		class Input {
			constructor() {
				this.mouse = {
					position: { x: 0, y: 0 },
					delta: { x: 0, y: 0 },
					scroll: { x: 0, y: 0 },
					buttons: []
				};
				this.keyboard = {
					keys: []
				};

				this.module = {};

				window.onmousemove = (e) => {
					this.mouse.position.x = e.clientX;
					this.mouse.position.y = e.clientY;
					this.mouse.delta.x = e.movementX;
					this.mouse.delta.y = e.movementY;
				};
				window.onwheel = (e) => {
					this.mouse.scroll.x = e.deltaX;
					this.mouse.scroll.y = e.deltaY;
				};
				window.onmousedown = (e) => { this.mouse.buttons[e.button] = true; };
				window.onmouseup = (e) => { this.mouse.buttons[e.button] = false; };
				window.addEventListener('wheel', (e) => { e.preventDefault(); }, { passive: false });
				window.oncontextmenu = (e) => { e.preventDefault(); };
				// window.onbeforeunload = (e) => { e.preventDefault(); return "Are you sure"; };
				window.onkeydown = (e) => { e.preventDefault(); this.keyboard.keys[e.which] = true; };
				window.onkeyup = (e) => { this.keyboard.keys[e.which] = false; };
			}
			// Put data in the input structure
			get(ptr) {
				const pos_del_scr = new Int32Array(this.module.instance.exports.memory.buffer, ptr, 6);
				pos_del_scr[0] = this.mouse.position.x;
				pos_del_scr[1] = this.mouse.position.y;
				pos_del_scr[2] = this.mouse.delta.x;
				pos_del_scr[3] = this.mouse.delta.y;
				pos_del_scr[4] = this.mouse.scroll.x;
				pos_del_scr[5] = this.mouse.scroll.y;
				const keys_buts = new Uint8Array(this.module.instance.exports.memory.buffer, ptr + 6 * 4, 256 + 5);
				for (let i = 0; i < 256; i++) {
					keys_buts[i] = this.keyboard.keys[i];
				}
				for (let i = 0; i < 5; i++) {
					keys_buts[256 + i] = this.mouse.buttons[i];
				}
			}
			// Values that need resetting each frame:
			update() {
				this.mouse.delta.x = 0;
				this.mouse.delta.y = 0;
				this.mouse.scroll.x = 0;
				this.mouse.scroll.y = 0;
			}
		}


		// Entry point of the application
		window.onload = async () => {
			// const strToTxt = (strptr) => {
			//     const memory_buffer = new Uint8Array(wasmModule.instance.exports.memory.buffer, strptr, wasmModule.instance.exports.strlen(strptr));
			//     let text_buffer = new TextDecoder().decode(memory_buffer);
			//     return text_buffer;
			// };

			const logger = new Logger();
			const input = new Input();

			const wasmModule = await WebAssembly.instantiateStreaming(
				fetch("./build/main.wasm"),
				{
					env: {
						// Printing (logging)
						env_ps: (s) => logger.printString(s),
						env_pn: (n) => logger.printNumber(n),
						env_pc: (c) => logger.printChar(c),
						// Polling input values all at once
						env_ig: (ptr) => input.get(ptr),
					}
				}
			);

			logger.module = wasmModule;
			input.module = wasmModule;

			wasmModule.instance.exports.main();

			const gameLoop = (dt) => {
				wasmModule.instance.exports.loop();

				input.update();
				window.requestAnimationFrame(gameLoop);
			};
			window.requestAnimationFrame(gameLoop);
		};
	</script>
</head>

<body>

</body>

</html>